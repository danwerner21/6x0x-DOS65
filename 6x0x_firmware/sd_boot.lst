ca65 V2.18 - Ubuntu 2.19-1
Main file   : sd_boot.asm
Current file: sd_boot.asm

000000r 1               
000000r 1               ;__SD_BOOT_________________________________________________________________________________________
000000r 1               ;
000000r 1               ;	Stage two boot for 6x0x DOS/65  (SD Card)
000000r 1               ;
000000r 1               ;	WRITTEN BY: DAN WERNER -- 1/1/2013
000000r 1               ;	updated for new BIOS   -- 2/5/2023
000000r 1               ;
000000r 1               ;__________________________________________________________________________________________________
000000r 1               
000000r 1               ; BIOS JUMP TABLE
000000r 1               IOF_CONIN       = $FD00         ; read a byte from CONSOLE ('A' POINTS TO BYTE)
000000r 1               IOF_CONINW      = $FD03         ; read a byte from CONSOLE ('A' POINTS TO BYTE, WAIT FOR BYTE)
000000r 1               IOF_OUTCH       = $FD06         ; write a byte from CONSOLE  ('A' POINTS TO BYTE)
000000r 1               IOF_CONSTATUS   = $FD09         ; RETURN CONSOLE STATUS
000000r 1               SERIALINIT      = $FD0C         ; called during OS init
000000r 1               RDSER1          = $FD0F         ; read a byte from serial port ('A' POINTS TO BYTE)
000000r 1               WRSER1          = $FD12         ; write a byte from serial port  ('A' POINTS TO BYTE)
000000r 1               RDSER1W         = $FD15         ; read a byte from serial port ('A' POINTS TO BYTE, WAIT FOR INPUT)
000000r 1               SERIALSTATUS    = $FD18         ; GET UART STATUS
000000r 1               SETUPDRIVE      = $FD1B         ; init floppy drive
000000r 1               READFL          = $FD1E         ; read sector from floppy
000000r 1               WRITEFL         = $FD21         ; write sector to floppy
000000r 1               PPP_SOFT_RESET  = $FD24         ; reset ppp sd drive
000000r 1               PPP_READ_SECTOR = $FD27         ; read ppp sd drive sector
000000r 1               PPP_WRITE_SECTOR = $FD2A        ; write ppp sd drive sector
000000r 1               IDE_SOFT_RESET  = $FD2D         ; reset ide drive
000000r 1               IDE_READ_SECTOR = $FD30         ; ide read sector
000000r 1               IDE_WRITE_SECTOR = $FD33        ; ide write sector
000000r 1               LOADS19         = $FD33         ; load s19 from serial port into ram
000000r 1               PPP_INITIALIZE  = $FD39         ; Initialize/Detect SD card
000000r 1               IDE_INITIALIZE  = $FD3C         ; Initialize/Detect IDE
000000r 1               
000000r 1               WORKPTR         = $32           ; WORK POINTER FOR COMMAND PROCESSOR
000000r 1               TEMPWORD1       = $38           ;
000000r 1               
000000r 1               sektrk          = $050C         ; seek track number
000000r 1               seksec          = $050E         ; seek sector number
000000r 1               debcyll         = $0510         ; DEBLOCKED CYLINDER LSB
000000r 1               debcylm         = $0511         ; DEBLOCKED CYLINDER MSB
000000r 1               debsehd         = $0512         ; DEBLOCKED SECTOR AND HEAD (HS)
000000r 1               sekdsk          = $0516         ; seek disk number
000000r 1               dskcfg          = $0517         ; 16 bytes disk configuration table
000000r 1               DSKUNIT         = $0528         ; seek disk number
000000r 1               slicetmp        = $0531         ; (word)
000000r 1               CURRENT_IDE_DRIVE = $0534
000000r 1               
000000r 1               
000000r 1               
000000r 1               OSENDPAGE       = $E0           ; stop loading when we hit this page
000000r 1               BOOTCODESTART   = $0800         ; LOCATION BOOT CODE WILL RUN IN
000000r 1               INBUFFER        = $0200         ; LOCATION BOOT CODE STARTED IN
000000r 1               
000000r 1               STARTADDRESS    = $B800         ; OS DEST ADDRESS
000000r 1               STARTOS         = $B800         ; VECTOR TO START OS
000000r 1               
000000r 1                       .PC02
000000r 1                       .SEGMENT "BUFFER"
000000r 1                       .ORG    $0200
000200  1               ;_______________________________________________________________
000200  1               ;
000200  1               ; RELOACTE CODE FROM DISK BUFFER, AND JUMP
000200  1               ;
000200  1               ;_______________________________________________________________
000200  1  A2 00                LDX     #$00
000202  1               :
000202  1  BD 00 02             LDA     INBUFFER,x
000205  1  9D 00 08             STA     BOOTCODESTART,x
000208  1  BD 00 03             LDA     INBUFFER+$100,x
00020B  1  9D 00 09             STA     BOOTCODESTART+$100,x
00020E  1  E8                   INX
00020F  1  E0 00                CPX     #$00
000211  1  D0 EF                BNE     :-
000213  1  4C 16 08             JMP     BOOTCODESTART+(BOOT-INBUFFER)
000216  1               
000216  1               ;__BOOT_________________________________________________________
000216  1               ;
000216  1               ; PERFORM SYSTEM BOOT  -- CODE MUST BE RELOCATABLE!
000216  1               ;
000216  1               ;_______________________________________________________________
000216  1               BOOT:
000216  1  A9 00                LDA     #$00
000218  1  8D 11 05             STA     debcylm         ; SET BOOT CODE LOCATION
00021B  1  8D 10 05             STA     debcyll         ; SET BOOT CODE LOCATION
00021E  1  A9 01                LDA     #$01            ;
000220  1  8D 12 05             STA     debsehd         ; SET BOOT CODE LOCATION
000223  1               ;
000223  1  A9 00                LDA     #<STARTADDRESS  ; SETUP OS LOAD LOCATION
000225  1  85 38                STA     TEMPWORD1       ;
000227  1  A9 B8                LDA     #>STARTADDRESS  ;
000229  1  85 39                STA     TEMPWORD1+1     ;
00022B  1               
00022B  1               BOOTLOOP:
00022B  1  A9 00                LDA     #<INBUFFER      ; SETUP DISK BUFFER
00022D  1  85 32                STA     WORKPTR         ;
00022F  1  A9 02                LDA     #>INBUFFER      ;
000231  1  85 33                STA     WORKPTR +1      ;
000233  1               ;
000233  1  20 27 FD             JSR     PPP_READ_SECTOR ;
000236  1  A0 00                LDY     #$00            ;
000238  1               :
000238  1  B1 32                LDA     (WORKPTR),Y     ;
00023A  1  91 38                STA     (TEMPWORD1),Y   ;
00023C  1  C8                   INY                     ;
00023D  1  D0 F9                BNE     :-              ;
00023F  1  E6 39                INC     TEMPWORD1+1     ;
000241  1  E6 33                INC     WORKPTR+1
000243  1               :
000243  1  B1 32                LDA     (WORKPTR),Y     ;
000245  1  91 38                STA     (TEMPWORD1),Y   ;
000247  1  C8                   INY                     ;
000248  1  D0 F9                BNE     :-              ;
00024A  1  E6 39                INC     TEMPWORD1+1     ;
00024C  1  A5 39                LDA     TEMPWORD1+1
00024E  1  C9 E0                CMP     #OSENDPAGE
000250  1  F0 09                BEQ     EXITBOOT        ;
000252  1  C9 E1                CMP     #OSENDPAGE+1
000254  1  F0 05                BEQ     EXITBOOT        ;
000256  1  EE 12 05             INC     debsehd         ;
000259  1  D0 D0                BNE     BOOTLOOP        ;
00025B  1               
00025B  1               EXITBOOT:
00025B  1  4C 00 B8             JMP     STARTOS         ; RUN THE OS
00025E  1               
00025E  1                       .SEGMENT "LOWCODE"
00025E  1                       .ORG    $0300
000300  1               ;_______________________________________________________________
000300  1               ;
000300  1               ; 	STORE CODE ON BOOT SECTOR
000300  1               ;
000300  1               ;_______________________________________________________________
000300  1  A9 00                LDA     #$00
000302  1  8D 11 05             STA     debcylm         ; SET BOOT CODE LOCATION
000305  1  8D 10 05             STA     debcyll         ; SET BOOT CODE LOCATION
000308  1  8D 12 05             STA     debsehd         ; SET BOOT CODE LOCATION
00030B  1  20 2A FD             JSR     PPP_WRITE_SECTOR;
00030E  1  00                   BRK
00030F  1               
00030F  1                       .END
